<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla de Observación de Clase de Física</title>

    <!-- Librería FileSaver.js para guardar archivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Librería html-docx-js para convertir HTML a DOCX -->
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx.js"></script>

    <!-- Firebase SDK (Software Development Kit) - Usando v9 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; line-height: 1.6; margin: 0; padding: 10px; background-color: #f0f2f5; color: #1c1e21; font-size: 16px; }
        .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1); }
        
        h1, h2, h3, h4 { color: #1c1e21; margin-bottom: 0.75em; }
        h1 { font-size: 1.75rem; text-align: center; color: #0d47a1; } /* Azul oscuro */
        h2 { font-size: 1.4rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.4em; color: #1565c0; } /* Azul medio */
        h3 { font-size: 1.2rem; margin-top: 1.8em; color: #1976d2; } /* Azul un poco más claro */
        h4 { font-size: 1rem; margin-top: 1.2em; color: #424242; font-style: italic; }

        label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="number"], textarea, select { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 16px; 
            border: 1px solid #dddfe2; 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-size: 0.95rem;
        }
        input:focus, textarea:focus, select:focus { border-color: #1877f2; box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2); outline: none;}
        textarea { min-height: 80px; resize: vertical; }

        .form-section, .section-block { margin-bottom: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px; background-color: #f9fafb; }
        
        /* Tablas */
        .observation-table, .notes-dynamic-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 15px; border: 1px solid #ccd0d5; border-radius: 6px; overflow: hidden; }
        .observation-table th, .observation-table td, .notes-dynamic-table th, .notes-dynamic-table td { border-bottom: 1px solid #ccd0d5; padding: 10px 12px; text-align: left; font-size: 0.9rem;}
        .observation-table td:not(:first-child), .notes-dynamic-table td:not(:first-child) { border-left: 1px solid #ccd0d5;}
        .observation-table th, .notes-dynamic-table th { background-color: #f5f6f7; font-weight: 600; color: #333; }
        .observation-table td:not(:first-child) { text-align: center; }
        .notes-dynamic-table textarea { width: 100%; box-sizing: border-box; min-height: 40px; border: 1px solid #ccd0d5; padding: 6px; border-radius: 4px; font-size:0.9rem; margin:0;}
        .notes-dynamic-table .delete-row-btn { padding: 6px 10px; background-color: #fa3e3e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size:0.8rem; }
        .notes-dynamic-table .delete-row-btn:hover { background-color: #e03030; }
        .observation-table tr:last-child td, .notes-dynamic-table tr:last-child td { border-bottom: none; }


        .actions, .saved-planillas-section, .auth-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        button { background-color: #1877f2; color: white; padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px; font-size: 0.95rem; font-weight: 600; transition: background-color 0.2s; }
        button:hover { background-color: #166fe5; }
        button:disabled { background-color: #bcc0c4; color:#777; cursor: not-allowed; }
        button.add-note-row { background-color: #42b72a; margin-bottom: 12px; }
        button.add-note-row:hover { background-color: #36a420; }
        #deletePlanilla, #deleteMiPlanilla { background-color: #fa3e3e; } /* Ya estaba */
        #deletePlanilla:hover, #deleteMiPlanilla:hover { background-color: #e03030; } /* Ya estaba */
        
        .saved-planillas-section select { padding: 10px; margin-right: 10px; border-radius: 6px; border: 1px solid #dddfe2; min-width: 250px; display: block; margin-bottom: 10px; font-size:0.95rem; }
        .auth-section input { margin-bottom:12px; }
        .user-info { margin-bottom:20px; padding:12px; background-color:#e7f3ff; border-left:5px solid #1877f2; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;}
        .user-info button { background-color: #6c757d; font-size: 0.85rem; padding: 8px 12px;}
        .user-info button:hover { background-color: #5a6268;}
        .hidden { display: none !important; }

        /* Estilos para Acordeón */
        .accordion-header {
            background-color: #e9ecef;
            color: #495057;
            cursor: pointer;
            padding: 12px 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            border-radius: 6px;
            margin-bottom: 0; /* Ajustado */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-header:hover { background-color: #d1d5db; }
        .accordion-header.active { background-color: #d1d5db; border-bottom-left-radius:0; border-bottom-right-radius:0; }
        .accordion-content {
            padding: 15px;
            display: none;
            overflow: hidden;
            background-color: #f9fafb; /* Mismo que .section-block */
            border: 1px solid #e0e0e0;
            border-top: none; /* Para que se una con el header */
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            margin-bottom: 20px; /* Espacio después del contenido del acordeón */
        }
        .accordion-arrow { font-size: 1.2rem; transition: transform 0.3s ease; }
        .accordion-header.active .accordion-arrow { transform: rotate(90deg); }


        /* DOCX Styles (se mantienen igual) */
        .docx-title { font-size: 22pt; text-align: center; margin-bottom: 20px; font-weight: bold; }
        .docx-subtitle { font-size: 16pt; margin-top: 20px; margin-bottom: 10px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
        .docx-section-title { font-size: 14pt; margin-top: 15px; margin-bottom: 8px; font-weight: bold; }
        .docx-notes-title { font-size: 12pt; margin-top: 10px; margin-bottom: 5px; font-style: italic; }
        .docx-label { font-weight: bold; }
        .docx-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .docx-table th, .docx-table td { border: 1px solid #000; padding: 5px; text-align: left; font-size:10pt; }
        .docx-table th { background-color: #f2f2f2; font-weight: bold; }
        .docx-table td.center { text-align: center; }
        .docx-paragraph { margin-bottom: 5px; font-size:11pt; }
        .tac-note { font-size: 9pt; font-style: italic; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-section">
            <div id="userInfo" class="user-info hidden">
                Bienvenido/a, <span id="userEmailDisplay"></span>.
                <button id="logoutButton">Cerrar Sesión</button>
            </div>
            <div id="authForm" class="">
                <h3>Iniciar Sesión / Registrarse</h3>
                <label for="email">Correo Electrónico:</label>
                <input type="email" id="email" placeholder="tu@correo.com">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" placeholder="Contraseña (mín. 6 caracteres)">
                <button id="loginButton">Iniciar Sesión</button>
                <button id="registerButton">Registrarse</button>
                <p id="authError" style="color:red;"></p>
            </div>
        </div>

        <h1>Planilla de Observación de Clase</h1>
        <p>Utiliza esta planilla para registrar tus observaciones. Las secciones pueden desplegarse haciendo clic en sus títulos.</p>

        <h2> Planilla modelo de observación de clase.</h2>
        <form id="observationForm">
            <!-- Datos Iniciales (siempre visible, no desplegable) -->
            <div class="form-section">
                <h3>Datos Iniciales</h3>
                <label for="observador">Observador/a: (Tu nombre o el del autor original)</label>
                <input type="text" id="observador" name="observador">
                <label for="fechaHora">Fecha y Hora:</label>
                <input type="text" id="fechaHora" name="fechaHora" placeholder="Ej: 2023-10-26 10:00">
                <label for="localidad">Localidad:</label>
                <input type="text" id="localidad" name="localidad">
                <label for="centroEducativo">Centro Educativo:</label>
                <input type="text" id="centroEducativo" name="centroEducativo">
                <label for="docenteObservado">Docente Observado/a:</label>
                <input type="text" id="docenteObservado" name="docenteObservado">
                <label for="asignatura">Asignatura / Unidad Curricular:</label>
                <input type="text" id="asignatura" name="asignatura">
                <label for="grupoNivel">Grupo / Nivel:</label>
                <input type="text" id="grupoNivel" name="grupoNivel">
                <label for="numEstudiantes">Nº de Estudiantes (Aprox):</label>
                <input type="number" id="numEstudiantes" name="numEstudiantes">
                <label for="objetivoObservacion">Objetivo de la Observación:</label>
                <textarea id="objetivoObservacion" name="objetivoObservacion" rows="3" placeholder="Ej: Analizar estrategias docentes, observar interacción, foco en clima de aula, etc."></textarea>
            </div>

            <!-- Sección Instalaciones (Desplegable) -->
            <div class="section-container" data-section-id="instalaciones">
                <button type="button" class="accordion-header">
                    Con respecto a las instalaciones
                    <span class="accordion-arrow">&#x276F;</span> <!-- Flecha derecha como ícono -->
                </button>
                <div class="accordion-content">
                    <table class="observation-table">
                        <thead><tr><th>Pregunta</th><th>SI</th><th>NO</th><th>Parcialmente</th></tr></thead>
                        <tbody>
                            <tr><td>¿La clase se dicta en un ambiente adecuado?</td><td><input type="radio" name="instalaciones_ambiente" value="SI"></td><td><input type="radio" name="instalaciones_ambiente" value="NO"></td><td><input type="radio" name="instalaciones_ambiente" value="Parcialmente"></td></tr>
                            <tr><td>¿El salón se encuentra en buenas condiciones?</td><td><input type="radio" name="instalaciones_condiciones" value="SI"></td><td><input type="radio" name="instalaciones_condiciones" value="NO"></td><td><input type="radio" name="instalaciones_condiciones" value="Parcialmente"></td></tr>
                            <tr><td>¿El salón dispone de los recursos necesarios?</td><td><input type="radio" name="instalaciones_recursos" value="SI"></td><td><input type="radio" name="instalaciones_recursos" value="NO"></td><td><input type="radio" name="instalaciones_recursos" value="Parcialmente"></td></tr>
                            <tr><td>¿El espacio se organiza de forma adecuada?</td><td><input type="radio" name="instalaciones_espacio" value="SI"></td><td><input type="radio" name="instalaciones_espacio" value="NO"></td><td><input type="radio" name="instalaciones_espacio" value="Parcialmente"></td></tr>
                            <tr><td>¿Cuentan con material didáctico tecnológico?</td><td><input type="radio" name="instalaciones_tecnologico" value="SI"></td><td><input type="radio" name="instalaciones_tecnologico" value="NO"></td><td><input type="radio" name="instalaciones_tecnologico" value="Parcialmente"></td></tr>
                            <tr><td>¿Los laboratorios están equipados de forma adecuada?</td><td><input type="radio" name="instalaciones_laboratorios" value="SI"></td><td><input type="radio" name="instalaciones_laboratorios" value="NO"></td><td><input type="radio" name="instalaciones_laboratorios" value="Parcialmente"></td></tr>
                        </tbody>
                    </table>
                    <h4>Notas (Observar: ruidos, ventanas rotas, temperatura en el aula, etc.)</h4>
                    <div class="notes-section" id="notes_instalaciones"><button type="button" class="add-note-row" data-target="notes_instalaciones_table_body">Añadir Fila de Notas</button><table class="notes-dynamic-table"><thead><tr><th>Hora</th><th>Descripción de los hechos</th><th>Impresiones subjetivas</th><th>Análisis de los hechos</th><th></th></tr></thead><tbody id="notes_instalaciones_table_body"></tbody></table></div>
                </div>
            </div>

            <!-- Sección Rol Docente (Desplegable) -->
            <div class="section-container" data-section-id="rolDocente">
                <button type="button" class="accordion-header">
                    Con respecto al rol docente
                    <span class="accordion-arrow">&#x276F;</span>
                </button>
                <div class="accordion-content">
                    <table class="observation-table">
                        <thead><tr><th>Pregunta</th><th>SI</th><th>NO</th><th>Parcialmente</th></tr></thead>
                        <tbody>
                            <tr><td>¿Promueve el respeto entre los alumnos?</td><td><input type="radio" name="rolDocente_respeto" value="SI"></td><td><input type="radio" name="rolDocente_respeto" value="NO"></td><td><input type="radio" name="rolDocente_respeto" value="Parcialmente"></td></tr>
                            <tr><td>¿Logra captar el interés y la atención de los alumnos?</td><td><input type="radio" name="rolDocente_interes" value="SI"></td><td><input type="radio" name="rolDocente_interes" value="NO"></td><td><input type="radio" name="rolDocente_interes" value="Parcialmente"></td></tr>
                            <tr><td>¿Utiliza ejemplos para facilitar el aprendizaje?</td><td><input type="radio" name="rolDocente_ejemplos" value="SI"></td><td><input type="radio" name="rolDocente_ejemplos" value="NO"></td><td><input type="radio" name="rolDocente_ejemplos" value="Parcialmente"></td></tr>
                            <tr><td>¿Se preocupa y ocupa si algún alumno no comprende?</td><td><input type="radio" name="rolDocente_preocupa" value="SI"></td><td><input type="radio" name="rolDocente_preocupa" value="NO"></td><td><input type="radio" name="rolDocente_preocupa" value="Parcialmente"></td></tr>
                            <tr><td>¿Utiliza variedad de recursos en la clase? ¿usa TAC?</td><td><input type="radio" name="rolDocente_variedadRecursos" value="SI"></td><td><input type="radio" name="rolDocente_variedadRecursos" value="NO"></td><td><input type="radio" name="rolDocente_variedadRecursos" value="Parcialmente"></td></tr>
                            <tr><td>¿Plantea diferentes estrategias metodológicas?</td><td><input type="radio" name="rolDocente_estrategias" value="SI"></td><td><input type="radio" name="rolDocente_estrategias" value="NO"></td><td><input type="radio" name="rolDocente_estrategias" value="Parcialmente"></td></tr>
                            <tr><td>¿Gestiona de forma correcta el tiempo y el espacio?</td><td><input type="radio" name="rolDocente_gestionTiempo" value="SI"></td><td><input type="radio" name="rolDocente_gestionTiempo" value="NO"></td><td><input type="radio" name="rolDocente_gestionTiempo" value="Parcialmente"></td></tr>
                            <tr><td>¿Mantiene el orden en el aula?</td><td><input type="radio" name="rolDocente_orden" value="SI"></td><td><input type="radio" name="rolDocente_orden" value="NO"></td><td><input type="radio" name="rolDocente_orden" value="Parcialmente"></td></tr>
                            <tr><td>¿Resuelve eficazmente problemas emergentes en clase?</td><td><input type="radio" name="rolDocente_problemasEmergentes" value="SI"></td><td><input type="radio" name="rolDocente_problemasEmergentes" value="NO"></td><td><input type="radio" name="rolDocente_problemasEmergentes" value="Parcialmente"></td></tr>
                            <tr><td>¿Realiza un cierre claro y pertinente de la clase?</td><td><input type="radio" name="rolDocente_cierre" value="SI"></td><td><input type="radio" name="rolDocente_cierre" value="NO"></td><td><input type="radio" name="rolDocente_cierre" value="Parcialmente"></td></tr>
                        </tbody>
                    </table>
                    <p class="tac-note">TAC: tecnologías del aprendizaje y el conocimiento (ej: presentación interactiva, kahoot, cuestionarios CREA, etc.).</p>
                    <h4>Notas</h4><div class="notes-section" id="notes_rolDocente"><button type="button" class="add-note-row" data-target="notes_rolDocente_table_body">Añadir Fila de Notas</button><table class="notes-dynamic-table"><thead><tr><th>Hora</th><th>Descripción de los hechos</th><th>Impresiones subjetivas</th><th>Análisis de los hechos</th><th></th></tr></thead><tbody id="notes_rolDocente_table_body"></tbody></table></div>
                </div>
            </div>

            <!-- Sección Interacción Docente-Estudiante (Desplegable) -->
            <div class="section-container" data-section-id="interaccion">
                <button type="button" class="accordion-header">
                    Interacción docente-estudiante
                    <span class="accordion-arrow">&#x276F;</span>
                </button>
                <div class="accordion-content">
                     <table class="observation-table">
                         <thead><tr><th>Pregunta</th><th>SI</th><th>NO</th><th>Parcialmente</th></tr></thead>
                        <tbody>
                            <tr><td>¿Muestra equidad en el trato con los estudiantes?</td><td><input type="radio" name="interaccion_equidad" value="SI"></td><td><input type="radio" name="interaccion_equidad" value="NO"></td><td><input type="radio" name="interaccion_equidad" value="Parcialmente"></td></tr>
                            <tr><td>¿Atiende la diversidad de aprendizajes?</td><td><input type="radio" name="interaccion_diversidad" value="SI"></td><td><input type="radio" name="interaccion_diversidad" value="NO"></td><td><input type="radio" name="interaccion_diversidad" value="Parcialmente"></td></tr>
                            <tr><td>¿Refuerza positivamente el avance de los estudiantes?</td><td><input type="radio" name="interaccion_refuerza" value="SI"></td><td><input type="radio" name="interaccion_refuerza" value="NO"></td><td><input type="radio" name="interaccion_refuerza" value="Parcialmente"></td></tr>
                            <tr><td>¿Fomenta la participación activa de los y las estudiantes?</td><td><input type="radio" name="interaccion_participacion" value="SI"></td><td><input type="radio" name="interaccion_participacion" value="NO"></td><td><input type="radio" name="interaccion_participacion" value="Parcialmente"></td></tr>
                            <tr><td>¿Integra a los estudiantes con ajuste razonable a la clase?</td><td><input type="radio" name="interaccion_integra" value="SI"></td><td><input type="radio" name="interaccion_integra" value="NO"></td><td><input type="radio" name="interaccion_integra" value="Parcialmente"></td></tr>
                            <tr><td>¿Se crean espacios para el debate y reflexión?</td><td><input type="radio" name="interaccion_debate" value="SI"></td><td><input type="radio" name="interaccion_debate" value="NO"></td><td><input type="radio" name="interaccion_debate" value="Parcialmente"></td></tr>
                        </tbody>
                    </table>
                    <h4>Notas</h4><div class="notes-section" id="notes_interaccion"><button type="button" class="add-note-row" data-target="notes_interaccion_table_body">Añadir Fila de Notas</button><table class="notes-dynamic-table"><thead><tr><th>Hora</th><th>Descripción de los hechos</th><th>Impresiones subjetivas</th><th>Análisis de los hechos</th><th></th></tr></thead><tbody id="notes_interaccion_table_body"></tbody></table></div>
                </div>
            </div>

            <!-- Sección Estudiantes (Desplegable) -->
            <div class="section-container" data-section-id="estudiantes">
                <button type="button" class="accordion-header">
                    Con respecto a los estudiantes
                    <span class="accordion-arrow">&#x276F;</span>
                </button>
                <div class="accordion-content">
                    <table class="observation-table">
                        <thead><tr><th>Pregunta</th><th>SI</th><th>NO</th><th>Parcialmente</th></tr></thead>
                        <tbody>
                            <tr><td>¿Respetan las normas de comportamiento?</td><td><input type="radio" name="estudiantes_normas" value="SI"></td><td><input type="radio" name="estudiantes_normas" value="NO"></td><td><input type="radio" name="estudiantes_normas" value="Parcialmente"></td></tr>
                            <tr><td>¿Participan en la clase?</td><td><input type="radio" name="estudiantes_participan" value="SI"></td><td><input type="radio" name="estudiantes_participan" value="NO"></td><td><input type="radio" name="estudiantes_participan" value="Parcialmente"></td></tr>
                            <tr><td>¿Presentan buena interacción entre ellos?</td><td><input type="radio" name="estudiantes_interaccion" value="SI"></td><td><input type="radio" name="estudiantes_interaccion" value="NO"></td><td><input type="radio" name="estudiantes_interaccion" value="Parcialmente"></td></tr>
                            <tr><td>¿Asisten a clase de forma regular?</td><td><input type="radio" name="estudiantes_asisten" value="SI"></td><td><input type="radio" name="estudiantes_asisten" value="NO"></td><td><input type="radio" name="estudiantes_asisten" value="Parcialmente"></td></tr>
                            <tr><td>¿Trabajan de forma ordenada y equitativa en subgrupos de trabajo?</td><td><input type="radio" name="estudiantes_trabajoGrupo" value="SI"></td><td><input type="radio" name="estudiantes_trabajoGrupo" value="NO"></td><td><input type="radio" name="estudiantes_trabajoGrupo" value="Parcialmente"></td></tr>
                            <tr><td>¿Hay respeto y colaboración entre los estudiantes?</td><td><input type="radio" name="estudiantes_respetoColaboracion" value="SI"></td><td><input type="radio" name="estudiantes_respetoColaboracion" value="NO"></td><td><input type="radio" name="estudiantes_respetoColaboracion" value="Parcialmente"></td></tr>
                        </tbody>
                    </table>
                    <h4>Notas</h4><div class="notes-section" id="notes_estudiantes"><button type="button" class="add-note-row" data-target="notes_estudiantes_table_body">Añadir Fila de Notas</button><table class="notes-dynamic-table"><thead><tr><th>Hora</th><th>Descripción de los hechos</th><th>Impresiones subjetivas</th><th>Análisis de los hechos</th><th></th></tr></thead><tbody id="notes_estudiantes_table_body"></tbody></table></div>
                </div>
            </div>
            
            <!-- Sección Reflexiones (siempre visible) -->
            <div class="form-section">
                <h3>Reflexiones de cierre:</h3>
                <label for="conclusiones">Conclusiones Preliminares:</label>
                <textarea id="conclusiones" name="conclusiones" rows="5"></textarea>
            </div>

            <div class="actions">
                <button type="button" id="savePlanilla" disabled>Guardar/Actualizar Planilla</button>
                <button type="button" id="exportDocx">Exportar a .docx</button>
                <button type="button" id="clearForm">Nueva Planilla (Limpiar)</button>
                <button type="button" id="saveAsNewCopyButton" class="hidden">Guardar Como Nueva Copia</button>
            </div>
        </form>

        <div id="planillasContent" class="hidden">
            <div class="saved-planillas-section">
                <h3>Mis Planillas (Editables)</h3>
                <select id="misPlanillasList">
                    <option value="">-- Selecciona una de tus planillas --</option>
                </select>
                <button type="button" id="loadMiPlanilla">Cargar Mi Planilla</button>
                <button type="button" id="deleteMiPlanilla">Eliminar Mi Planilla</button>
            </div>

            <div class="saved-planillas-section">
                <h3>Planillas de Otros Compañeros (Solo Lectura)</h3>
                <select id="otrasPlanillasList">
                    <option value="">-- Selecciona una planilla para ver --</option>
                </select>
                <button type="button" id="loadOtraPlanilla">Ver Planilla de Compañero</button>
            </div>
        </div>
    </div>

    <script>
   document.addEventListener('DOMContentLoaded', () => {
    // --- Configuración e Inicialización de Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBIYYqoptI6c3iVFqNWcOqd4XJXkzCyObM",
      authDomain: "planilla-de-obs.firebaseapp.com",
      projectId: "planilla-de-obs",
      storageBucket: "planilla-de-obs.appspot.com",
      messagingSenderId: "221182459308",
      appId: "1:221182459308:web:3e62837cd8592cea7bce09",
      measurementId: "G-QB6FJS3Y80"
    };

    let db;
    let auth;
    let currentUser = null;
    let currentLoadedPlanillaData = null;
    let misPlanillasListenerUnsubscribe = null;
    let otrasPlanillasListenerUnsubscribe = null;

    try {
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log("Firebase inicializado correctamente.");
        } else { throw new Error("SDK de Firebase no cargado."); }
    } catch (e) {
        console.error("Error inicializando Firebase: ", e);
        alert("Error crítico: No se pudo inicializar la conexión con la base de datos.");
    }

    // --- Selectores de Elementos del DOM ---
    const form = document.getElementById('observationForm');
    const savePlanillaBtn = document.getElementById('savePlanilla');
    const exportDocxBtn = document.getElementById('exportDocx');
    const clearFormBtn = document.getElementById('clearForm');
    const saveAsNewCopyButton = document.getElementById('saveAsNewCopyButton');

    const authFormDiv = document.getElementById('authForm');
    const userInfoDiv = document.getElementById('userInfo');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const loginButton = document.getElementById('loginButton');
    const registerButton = document.getElementById('registerButton');
    const logoutButton = document.getElementById('logoutButton');
    const authErrorP = document.getElementById('authError');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    const planillasContentDiv = document.getElementById('planillasContent');
    const misPlanillasSelect = document.getElementById('misPlanillasList');
    const loadMiPlanillaBtn = document.getElementById('loadMiPlanilla');
    const deleteMiPlanillaBtn = document.getElementById('deleteMiPlanilla');
    const otrasPlanillasSelect = document.getElementById('otrasPlanillasList');
    const loadOtraPlanillaBtn = document.getElementById('loadOtraPlanilla');

    // --- Lógica de Acordeón ---
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            header.classList.toggle('active');
            // Alternar visibilidad del contenido
            if (content.style.display === "block") {
                content.style.display = "none";
            } else {
                content.style.display = "block";
            }
            // Actualizar estado de edición del contenido del acordeón específico
            updateAccordionContentEditableState(content, !form.elements[0].disabled);
        });
    });

    function updateAccordionContentEditableState(contentElement, isFormEditable) {
        if (!contentElement) return;
        contentElement.querySelectorAll('.add-note-row, .delete-row-btn').forEach(btn => {
            btn.disabled = !isFormEditable;
        });
        contentElement.querySelectorAll('textarea').forEach(ta => {
            ta.disabled = !isFormEditable;
        });
    }


    // --- Lógica de Autenticación ---
    if (auth) {
        auth.onAuthStateChanged(user => {
            currentUser = user; // Actualizar currentUser primero
            if (user) {
                userInfoDiv.classList.remove('hidden');
                authFormDiv.classList.add('hidden');
                userEmailDisplay.textContent = user.email;
                planillasContentDiv.classList.remove('hidden');
                
                loadMisPlanillas();
                loadOtrasPlanillas();
            } else {
                userInfoDiv.classList.add('hidden');
                authFormDiv.classList.remove('hidden');
                planillasContentDiv.classList.add('hidden');
                
                if (misPlanillasListenerUnsubscribe) misPlanillasListenerUnsubscribe();
                if (otrasPlanillasListenerUnsubscribe) otrasPlanillasListenerUnsubscribe();
                misPlanillasListenerUnsubscribe = null;
                otrasPlanillasListenerUnsubscribe = null;

                misPlanillasSelect.innerHTML = '<option value="">-- Inicia sesión --</option>';
                otrasPlanillasSelect.innerHTML = '<option value="">-- Inicia sesión --</option>';
                clearFullFormAndState();
            }
            // Siempre actualizar el estado del formulario después de cambiar el estado de autenticación
            updateFormBasedOnLoadedPlanilla();
        });

        loginButton.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            authErrorP.textContent = '';
            if (!email || !password) {
                authErrorP.textContent = 'Por favor, ingresa correo y contraseña.';
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Error iniciando sesión:", error.code, error.message);
                    authErrorP.textContent = `Error: ${error.message}`;
                });
        });

        registerButton.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            authErrorP.textContent = '';

            if (!email) { authErrorP.textContent = 'Error: El correo electrónico no puede estar vacío.'; return; }
            if (!/^\S+@\S+\.\S+$/.test(email)) { authErrorP.textContent = 'Error: El formato del correo electrónico no es válido.'; return; }
            if (password.length < 6) { authErrorP.textContent = 'Error: La contraseña debe tener al menos 6 caracteres.'; return; }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Usuario registrado:", userCredential.user);
                    authErrorP.textContent = '¡Registro exitoso! Ahora puedes iniciar sesión.';
                    emailInput.value = ''; 
                    passwordInput.value = '';
                })
                .catch(error => {
                    console.error("Error registrando:", error.code, error.message);
                    if (error.code === 'auth/email-already-in-use') {
                        authErrorP.textContent = 'Error: Esta dirección de correo electrónico ya está en uso.';
                    } else { authErrorP.textContent = `Error registrando: ${error.message}`; }
                });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut().catch(error => console.error("Error cerrando sesión:", error));
        });
    } else {
        console.error("Firebase Auth no está disponible.");
        alert("Error crítico: El servicio de autenticación no está disponible.");
        // Deshabilitar botones de auth si Firebase Auth no se carga
        if(loginButton) loginButton.disabled = true;
        if(registerButton) registerButton.disabled = true;
    }

    // --- Funciones para Notas Dinámicas ---
    document.querySelectorAll('.add-note-row').forEach(button => {
        button.addEventListener('click', (e) => {
            if (button.disabled) return;
            const targetTableBodyId = button.dataset.target;
            const tableBody = document.getElementById(targetTableBodyId);
            addNoteRowToTable(tableBody);
        });
    });

    function addNoteRowToTable(tableBody, data = { hora: '', descripcion: '', impresiones: '', analisis: '' }) {
        const isFormMainFieldsDisabled = form.elements['observador']?.disabled || false; // Chequear un campo principal del form
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td><textarea name="${tableBody.id}_hora[]" rows="1" ${isFormMainFieldsDisabled ? 'disabled' : ''}>${data.hora}</textarea></td>
            <td><textarea name="${tableBody.id}_descripcion[]" rows="2" ${isFormMainFieldsDisabled ? 'disabled' : ''}>${data.descripcion}</textarea></td>
            <td><textarea name="${tableBody.id}_impresiones[]" rows="2" ${isFormMainFieldsDisabled ? 'disabled' : ''}>${data.impresiones}</textarea></td>
            <td><textarea name="${tableBody.id}_analisis[]" rows="2" ${isFormMainFieldsDisabled ? 'disabled' : ''}>${data.analisis}</textarea></td>
            <td><button type="button" class="delete-row-btn" ${isFormMainFieldsDisabled ? 'disabled' : ''}>X</button></td>
        `;
        row.querySelector('.delete-row-btn').addEventListener('click', function() {
            if (this.disabled) return;
            this.closest('tr').remove();
        });
    }
    
    function getNotesDataForStorage(tableBodyId) {
        const tableBody = document.getElementById(tableBodyId);
        if (!tableBody) return [];
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        return rows.map(row => {
            const textareas = row.querySelectorAll('textarea');
            return {
                hora: textareas[0] ? textareas[0].value : '',
                descripcion: textareas[1] ? textareas[1].value : '',
                impresiones: textareas[2] ? textareas[2].value : '',
                analisis: textareas[3] ? textareas[3].value : ''
            };
        });
    }

    function getNotesDataForDocx(tableBodyId) {
        const tableBody = document.getElementById(tableBodyId);
        if (!tableBody) return [];
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        return rows.map(row => {
            const textareas = row.querySelectorAll('textarea');
            return {
                hora: textareas[0] ? textareas[0].value.replace(/\n/g, '<br>') : '',
                descripcion: textareas[1] ? textareas[1].value.replace(/\n/g, '<br>') : '',
                impresiones: textareas[2] ? textareas[2].value.replace(/\n/g, '<br>') : '',
                analisis: textareas[3] ? textareas[3].value.replace(/\n/g, '<br>') : ''
            };
        });
    }

    function populateNotesTable(tableBodyId, notesData) { 
        const tableBody = document.getElementById(tableBodyId);
        if (!tableBody) return;
        tableBody.innerHTML = ''; 
        if (notesData && notesData.length > 0) {
            notesData.forEach(note => addNoteRowToTable(tableBody, note));
        }
    }

    // --- Funciones de Formulario ---
    function getFormData() {
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (key.endsWith('[]')) {} else if (form.elements[key] && form.elements[key].type === 'radio') {
                if (form.elements[key].checked) data[key] = value;
            } else { data[key] = value; }
        }
        data.notes_instalaciones = getNotesDataForStorage('notes_instalaciones_table_body');
        data.notes_rolDocente = getNotesDataForStorage('notes_rolDocente_table_body');
        data.notes_interaccion = getNotesDataForStorage('notes_interaccion_table_body');
        data.notes_estudiantes = getNotesDataForStorage('notes_estudiantes_table_body');
        document.querySelectorAll('input[type="radio"]').forEach(radio => { if (radio.checked) data[radio.name] = radio.value; });
        return data;
    }

    function populateForm(data) { 
        form.reset(); 
        for (const key in data) {
            if (key.startsWith('notes_')) { 
                populateNotesTable(key + '_table_body', data[key]);
            } else if (['creadorUid', 'creadoEn', 'actualizadoEn', 'creadorEmail', 'id'].includes(key)) {
            } else {
                const element = form.elements[key];
                if (element) {
                   if (element.length && element[0].type === 'radio') {
                        Array.from(element).forEach(radio => { radio.checked = (radio.value === data[key]); });
                    } else if (element.type === 'radio') {
                        element.checked = (element.value === data[key]);
                    } else { element.value = data[key] || ''; }
                }
            }
        }
        // El estado de edición se actualiza después de poblar
        updateFormBasedOnLoadedPlanilla();
    }

    function updateFormBasedOnLoadedPlanilla() {
        let isFormEditable = false; // Por defecto, no editable

        if (currentUser) { // Solo si hay un usuario logueado, el formulario PUEDE ser editable
            if (currentLoadedPlanillaData) { // Si hay una planilla cargada
                if (currentLoadedPlanillaData.creadorUid === currentUser.uid) {
                    isFormEditable = true; // Es mi planilla
                } else {
                    isFormEditable = false; // Es planilla de otro (solo lectura)
                }
            } else {
                isFormEditable = true; // No hay planilla cargada, formulario para nueva (editable)
            }
        }

        // Deshabilitar/Habilitar campos principales del formulario
        Array.from(form.elements).forEach(element => {
            const noDisable = ['button', 'submit', 'reset']; // Tipos que no se deshabilitan por esta lógica
            if (!noDisable.includes(element.type) && 
                element.id !== 'misPlanillasList' && 
                element.id !== 'otrasPlanillasList' &&
                element.id !== 'loadMiPlanilla' && // No deshabilitar botones de carga
                element.id !== 'loadOtraPlanilla' &&
                element.id !== 'deleteMiPlanilla' &&
                element.id !== 'email' && // No deshabilitar campos de auth
                element.id !== 'password' &&
                element.id !== 'loginButton' &&
                element.id !== 'registerButton' &&
                element.id !== 'logoutButton'
                ) {
                 element.disabled = !isFormEditable;
            }
        });
        
        // Actualizar estado de edición para el contenido de todos los acordeones
        document.querySelectorAll('.accordion-content').forEach(content => {
            updateAccordionContentEditableState(content, isFormEditable);
        });


        // Lógica para botones de acción principales
        savePlanillaBtn.disabled = !currentUser; // Solo habilitado si hay sesión
        if (currentUser) {
            if (currentLoadedPlanillaData && currentLoadedPlanillaData.creadorUid === currentUser.uid) {
                savePlanillaBtn.textContent = "Actualizar Mi Planilla";
                saveAsNewCopyButton.classList.remove('hidden');
            } else if (currentLoadedPlanillaData && currentLoadedPlanillaData.creadorUid !== currentUser.uid) {
                savePlanillaBtn.textContent = "Guardar Como Nueva (Mi Copia)"; // Si carga la de otro, el btn principal guarda como copia
                saveAsNewCopyButton.classList.add('hidden'); 
            } else { // No hay planilla cargada, o se limpió
                savePlanillaBtn.textContent = "Guardar Nueva Planilla";
                saveAsNewCopyButton.classList.add('hidden');
            }
        } else { // No hay usuario
            savePlanillaBtn.textContent = "Guardar Planilla";
            saveAsNewCopyButton.classList.add('hidden');
            savePlanillaBtn.disabled = true;
        }
    }
            
    function clearFullFormAndState() {
        form.reset();
        document.querySelectorAll('.notes-dynamic-table tbody').forEach(tbody => tbody.innerHTML = '');
        document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
        document.querySelectorAll('.accordion-content').forEach(content => content.style.display = 'none');
        document.querySelectorAll('.accordion-header.active').forEach(header => header.classList.remove('active'));
        misPlanillasSelect.value = "";
        otrasPlanillasSelect.value = "";
        currentLoadedPlanillaData = null; 
        updateFormBasedOnLoadedPlanilla(); 
    }

    // --- Funciones CRUD con Firebase Firestore ---
    savePlanillaBtn.addEventListener('click', async () => {
        if (!db || !currentUser) { alert("Debes iniciar sesión para guardar."); return; }
        
        const dataToSave = getFormData();
        
        if (currentLoadedPlanillaData && currentLoadedPlanillaData.creadorUid === currentUser.uid) { 
            dataToSave.actualizadoEn = firebase.firestore.FieldValue.serverTimestamp();
            try {
                await db.collection("planillas").doc(currentLoadedPlanillaData.id).set(dataToSave, { merge: true });
                alert('Planilla actualizada con éxito!');
            } catch (error) { console.error("Error al actualizar la planilla: ", error); alert('Error al actualizar la planilla.'); }
        } else { 
            dataToSave.creadorUid = currentUser.uid;
            dataToSave.creadorEmail = currentUser.email; 
            dataToSave.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
            try {
                const docRef = await db.collection("planillas").add(dataToSave);
                alert('Nueva planilla guardada con éxito! ID: ' + docRef.id);
                clearFullFormAndState(); 
            } catch (error) { console.error("Error al guardar nueva planilla: ", error); alert('Error al guardar la nueva planilla.'); }
        }
    });

    saveAsNewCopyButton.addEventListener('click', async () => {
        if (!db || !currentUser) { alert("Debes iniciar sesión para guardar una copia."); return; }
        
        const dataToSave = getFormData();
        dataToSave.creadorUid = currentUser.uid;
        dataToSave.creadorEmail = currentUser.email; 
        dataToSave.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
        delete dataToSave.actualizadoEn; 

        try {
            const docRef = await db.collection("planillas").add(dataToSave);
            alert('Copia guardada como nueva planilla! ID: ' + docRef.id);
            clearFullFormAndState();
        } catch (error) { console.error("Error al guardar como nueva copia: ", error); alert('Error al guardar la copia.'); }
    });

    function loadAndSubscribePlanillas(selectElement, forCurrentUser) {
        if (!db || !currentUser) {
            selectElement.innerHTML = `<option value="">-- Inicia sesión --</option>`;
            if (forCurrentUser && misPlanillasListenerUnsubscribe) misPlanillasListenerUnsubscribe();
            if (!forCurrentUser && otrasPlanillasListenerUnsubscribe) otrasPlanillasListenerUnsubscribe();
            return;
        }

        selectElement.innerHTML = `<option value="">-- Cargando... --</option>`;
        let queryBase = db.collection("planillas");
        let query;

        if (forCurrentUser) {
            query = queryBase.where("creadorUid", "==", currentUser.uid)
                             .orderBy("creadoEn", "desc");
            if (misPlanillasListenerUnsubscribe) misPlanillasListenerUnsubscribe();
            misPlanillasListenerUnsubscribe = query.onSnapshot(snapshotHandler(selectElement, true), errorHandler(selectElement, "Mis Planillas"));
        } else {
            query = queryBase.where("creadorUid", "!=", currentUser.uid)
                             .orderBy("creadorUid")
                             .orderBy("creadoEn", "desc"); 
            if (otrasPlanillasListenerUnsubscribe) otrasPlanillasListenerUnsubscribe();
            otrasPlanillasListenerUnsubscribe = query.onSnapshot(snapshotHandler(selectElement, false), errorHandler(selectElement, "Otras Planillas"));
        }
    }

    function snapshotHandler(selectElement, isMyList) {
        return (querySnapshot) => {
            const previousSelectedValue = selectElement.value;
            selectElement.innerHTML = `<option value="">-- Selecciona una planilla --</option>`;
            
            if (querySnapshot.empty) {
                selectElement.innerHTML = `<option value="">-- No hay planillas ${isMyList ? 'tuyas' : 'de otros'} --</option>`;
                return;
            }
            let currentSelectionStillExists = false;
            querySnapshot.forEach((doc) => {
                const planillaData = doc.data();
                let displayName = `De: ${planillaData.creadorEmail || `Usuario ${doc.data().creadorUid ? doc.data().creadorUid.slice(0,6) : 'Desconocido' }`} (${doc.id.slice(-4)})`;
                if (planillaData.observador && planillaData.fechaHora) {
                    displayName = `${planillaData.observador} (${planillaData.fechaHora}) - por ${planillaData.creadorEmail || 'Desconocido'}`;
                } else if (planillaData.observador) {
                     displayName = `${planillaData.observador} - por ${planillaData.creadorEmail || 'Desconocido'}`;
                }
                
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = displayName;
                option.dataset.creatorUid = planillaData.creadorUid;
                selectElement.appendChild(option);
                if(doc.id === previousSelectedValue) currentSelectionStillExists = true;
            });
            if(currentSelectionStillExists) selectElement.value = previousSelectedValue;
        };
    }

    function errorHandler(selectElement, listName) {
        return (error) => {
            console.error(`Error cargando lista de "${listName}": `, error);
            selectElement.innerHTML = `<option value="">-- Error al cargar ${listName} --</option>`;
        };
    }
    
    function loadMisPlanillas() { loadAndSubscribePlanillas(misPlanillasSelect, true); }
    function loadOtrasPlanillas() { loadAndSubscribePlanillas(otrasPlanillasSelect, false); }


    async function loadSpecificPlanilla(selectedPlanillaId) { 
        if (!db) { alert("Base de datos no inicializada."); return; }
        if (!selectedPlanillaId) { return; }

        try {
            const docRef = db.collection("planillas").doc(selectedPlanillaId);
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                const data = { ...docSnap.data(), id: docSnap.id };
                currentLoadedPlanillaData = data; 
                populateForm(data); 
                alert(`Planilla '${data.observador || selectedPlanillaId}' cargada.`);
            } else {
                alert("Error: No se encontró la planilla seleccionada.");
                clearFullFormAndState();
            }
        } catch (error) {
            alert('Error al cargar la planilla.');
            console.error("Error al cargar planilla: ", error);
            clearFullFormAndState();
        }
    }

    loadMiPlanillaBtn.addEventListener('click', () => loadSpecificPlanilla(misPlanillasSelect.value));
    loadOtraPlanillaBtn.addEventListener('click', () => loadSpecificPlanilla(otrasPlanillasSelect.value));
            
    deleteMiPlanillaBtn.addEventListener('click', async () => {
        if (!db || !currentUser) { alert("Debes iniciar sesión."); return; }
        const selectedPlanillaId = misPlanillasSelect.value; 
        if (selectedPlanillaId) {
            const selectedOption = misPlanillasSelect.options[misPlanillasSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.creatorUid !== currentUser.uid) {
                alert("Error: No puedes eliminar una planilla que no te pertenece."); return;
            }
            if (confirm('¿Estás seguro de que quieres eliminar ESTA DE TUS planillas de la nube?')) {
                try {
                    await db.collection("planillas").doc(selectedPlanillaId).delete();
                    alert('Tu planilla ha sido eliminada.');
                    clearFullFormAndState(); 
                } catch (error) { alert('Error al eliminar tu planilla.'); console.error("Error al eliminar tu planilla: ", error); }
            }
        } else { alert('Por favor, selecciona una de TUS planillas para eliminar.'); }
    });

    clearFormBtn.addEventListener('click', () => { clearFullFormAndState(); });

    exportDocxBtn.addEventListener('click', () => {
        if (typeof window.htmlDocx === 'undefined' || typeof window.saveAs === 'undefined') {
            alert('Error: Librerías necesarias para exportar a DOCX no están cargadas.'); return;
        }
        const data = getFormData();
        let htmlString = `<!DOCTYPE html><html><head><meta charset='UTF-8'><style>
            body { font-family: Arial, sans-serif; font-size: 11pt; }
            .docx-title { font-size: 20pt; text-align: center; margin-bottom: 20px; font-weight: bold; }
            .docx-subtitle { font-size: 16pt; margin-top: 20px; margin-bottom: 10px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
            .docx-section-title { font-size: 14pt; margin-top: 15px; margin-bottom: 8px; font-weight: bold; }
            .docx-notes-title { font-size: 12pt; margin-top: 10px; margin-bottom: 5px; font-style: italic; }
            .docx-label { font-weight: bold; }
            .docx-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            .docx-table th, .docx-table td { border: 1px solid #333; padding: 6px; text-align: left; font-size:10pt; }
            .docx-table th { background-color: #e9ecef; font-weight: bold; }
            .docx-table td.center { text-align: center; }
            .docx-paragraph { margin-bottom: 8px; font-size:11pt; line-height: 1.4; }
            .tac-note { font-size: 9pt; font-style: italic; margin-top: 5px; }
            </style></head><body>
            <h1 class="docx-title">Planilla de Observación de Clase de Física</h1>
            <h2 class="docx-subtitle">R 3) Planilla modelo de observación de clase</h2>
        `;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Observador/a:</span> ${data.observador || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Fecha y Hora:</span> ${data.fechaHora || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Localidad:</span> ${data.localidad || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Centro Educativo:</span> ${data.centroEducativo || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Docente Observado/a:</span> ${data.docenteObservado || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Asignatura / Unidad Curricular:</span> ${data.asignatura || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Grupo / Nivel:</span> ${data.grupoNivel || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Nº de Estudiantes (Aprox):</span> ${data.numEstudiantes || 'N/A'}</div>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Objetivo de la Observación:</span><br>${data.objetivoObservacion ? data.objetivoObservacion.replace(/\n/g, '<br>') : 'N/A'}</div>`;

        function generateQuestionTableHTML(title, questionsData, sectionPrefix) {
            let tableHtml = `<h3 class="docx-section-title">${title}</h3><table class="docx-table"><thead><tr><th>Pregunta</th><th>SI</th><th>NO</th><th>Parcialmente</th></tr></thead><tbody>`;
            questionsData.forEach(q => {
                const value = data[`${sectionPrefix}_${q.key}`] || '';
                tableHtml += `<tr><td>${q.text}</td><td class="center">${value === 'SI' ? 'X' : ''}</td><td class="center">${value === 'NO' ? 'X' : ''}</td><td class="center">${value === 'Parcialmente' ? 'X' : ''}</td></tr>`;
            });
            return tableHtml + `</tbody></table>`;
        }
        function generateNotesTableHTMLForDocx(title, notesTableBodyId) { 
            const notesArray = getNotesDataForDocx(notesTableBodyId);
            let notesHtml = `<h4 class="docx-notes-title">${title}</h4>`;
            if (notesArray && notesArray.length > 0 && notesArray.some(n => n.hora || n.descripcion || n.impresiones || n.analisis)) {
                notesHtml += `<table class="docx-table"><thead><tr><th>Hora</th><th>Descripción de los hechos</th><th>Impresiones subjetivas</th><th>Análisis de los hechos</th></tr></thead><tbody>`;
                notesArray.forEach(note => {
                    notesHtml += `<tr><td>${note.hora || ''}</td><td>${note.descripcion || ''}</td><td>${note.impresiones || ''}</td><td>${note.analisis || ''}</td></tr>`;
                });
                notesHtml += `</tbody></table>`;
            } else { notesHtml += `<div class="docx-paragraph"><em>(Sin notas registradas)</em></div>`; }
            return notesHtml;
        }
        
        const sectionsToExport = [
            { id: 'instalaciones', title: "Con respecto a las instalaciones:", questions: [ { text: "¿La clase se dicta en un ambiente adecuado?", key: "ambiente" }, { text: "¿El salón se encuentra en buenas condiciones?", key: "condiciones" }, { text: "¿El salón dispone de los recursos necesarios?", key: "recursos" }, { text: "¿El espacio se organiza de forma adecuada?", key: "espacio" }, { text: "¿Cuentan con material didáctico tecnológico?", key: "tecnologico" }, { text: "¿Los laboratorios están equipados de forma adecuada?", key: "laboratorios" }], notesTitle: "Notas (Instalaciones - Observar: ruidos, ventanas rotas, temperatura en el aula, etc.):", notesId: "notes_instalaciones_table_body"},
            { id: 'rolDocente', title: "Con respecto al rol docente:", questions: [ { text: "¿Promueve el respeto entre los alumnos?", key: "respeto" }, { text: "¿Logra captar el interés y la atención de los alumnos?", key: "interes" }, { text: "¿Utiliza ejemplos para facilitar el aprendizaje?", key: "ejemplos" }, { text: "¿Se preocupa y ocupa si algún alumno no comprende?", key: "preocupa" }, { text: "¿Utiliza variedad de recursos en la clase? ¿usa TAC?", key: "variedadRecursos" }, { text: "¿Plantea diferentes estrategias metodológicas?", key: "estrategias" }, { text: "¿Gestiona de forma correcta el tiempo y el espacio?", key: "gestionTiempo" }, { text: "¿Mantiene el orden en el aula?", key: "orden" }, { text: "¿Resuelve eficazmente problemas emergentes en clase?", key: "problemasEmergentes" }, { text: "¿Realiza un cierre claro y pertinente de la clase?", key: "cierre" }], notesTitle: "Notas (Rol Docente):", notesId: "notes_rolDocente_table_body", extraHtml: `<div class="tac-note docx-paragraph">TAC: tecnologías del aprendizaje y el conocimiento (ej: presentación interactiva, kahoot, cuestionarios CREA, etc.).</div>` },
            { id: 'interaccion', title: "Interacción docente-estudiante:", questions: [ { text: "¿Muestra equidad en el trato con los estudiantes?", key: "equidad" }, { text: "¿Atiende la diversidad de aprendizajes?", key: "diversidad" }, { text: "¿Refuerza positivamente el avance de los estudiantes?", key: "refuerza" }, { text: "¿Fomenta la participación activa de los y las estudiantes?", key: "participacion" }, { text: "¿Integra a los estudiantes con ajuste razonable a la clase?", key: "integra" }, { text: "¿Se crean espacios para el debate y reflexión?", key: "debate" }], notesTitle: "Notas (Interacción Docente-Estudiante):", notesId: "notes_interaccion_table_body"},
            { id: 'estudiantes', title: "Con respecto a los estudiantes:", questions: [ { text: "¿Respetan las normas de comportamiento?", key: "normas" }, { text: "¿Participan en la clase?", key: "participan" }, { text: "¿Presentan buena interacción entre ellos?", key: "interaccion" }, { text: "¿Asisten a clase de forma regular?", key: "asisten" }, { text: "¿Trabajan de forma ordenada y equitativa en subgrupos de trabajo?", key: "trabajoGrupo" }, { text: "¿Hay respeto y colaboración entre los estudiantes?", key: "respetoColaboracion" }], notesTitle: "Notas (Estudiantes):", notesId: "notes_estudiantes_table_body"}
        ];

        sectionsToExport.forEach(section => {
            const sectionContainer = document.querySelector(`.section-container[data-section-id="${section.id}"]`);
            const accordionHeader = sectionContainer.querySelector('.accordion-header');
            if (accordionHeader && accordionHeader.classList.contains('active')) {
                htmlString += generateQuestionTableHTML(section.title, section.questions, section.id);
                if (section.extraHtml) htmlString += section.extraHtml;
                htmlString += generateNotesTableHTMLForDocx(section.notesTitle, section.notesId);
            }
        });
        htmlString += `<h3 class="docx-section-title">Reflexiones de cierre:</h3>`;
        htmlString += `<div class="docx-paragraph"><span class="docx-label">Conclusiones Preliminares:</span><br>${data.conclusiones ? data.conclusiones.replace(/\n/g, '<br>') : 'N/A'}</div>`;
        htmlString += `</body></html>`;

        try {
            const converted = window.htmlDocx.asBlob(htmlString);
            const fileName = `Planilla_Observacion_${(data.observador || 'Generica').replace(/[^a-zA-Z0-9-_]/g, '')}_${(data.fechaHora || new Date().toISOString().slice(0,10)).replace(/[^a-zA-Z0-9-_]/g, '')}.docx`;
            window.saveAs(converted, fileName);
        } catch (error) { console.error("Error generando DOCX:", error); alert("Error al generar el archivo .docx.\n" + error.message); }
    });
});
</script>
</body>
</html>